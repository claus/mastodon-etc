---
import styles from './EmojiPicker.module.css';

interface Emoji {
    code: string;
    url: string;
    static_url: string;
    visible: boolean;
    category?: string;
}

interface Props {
    categories: Record<string, Emoji[]>;
    baseUrl: string;
    status: number;
    statusText?: string;
}

const { categories, baseUrl, status, statusText } = Astro.props;

const showStaticVersion = false;
---

{
    status >= 400 ? (
        <div class={styles.error}>
            <h2 class={styles.errorTitle}>Erro {status}</h2>
            <p class={styles.errorMessage}>{statusText}</p>
        </div>
    ) : !categories || Object.keys(categories).length === 0 ? (
        <div class={styles.error}>
            <p class={styles.errorMessage}>Não tem emojis personalizados nessa instância.</p>
        </div>
    ) : (
        <emoji-picker class={styles.root}>
            {Object.entries(categories)
                .sort(([a], [b]) => a.toLocaleLowerCase().localeCompare(b.toLocaleLowerCase()))
                .map(([category, emojis]) => (
                    <div class={styles.emojiCategory}>
                        <h2>{category || 'Sem categoria'}</h2>
                        <div class={styles.emojiGrid}>
                            {emojis
                                .sort((a, b) =>
                                    a.code
                                        .toLocaleLowerCase()
                                        .localeCompare(b.code.toLocaleLowerCase())
                                )
                                .map(emoji => {
                                    const src =
                                        baseUrl +
                                        (showStaticVersion ? emoji.static_url : emoji.url);
                                    return (
                                        <button aria-label={emoji.code} class={styles.emojiButton}>
                                            <img
                                                class={styles.image}
                                                aria-disabled="true"
                                                src={src}
                                                width="32"
                                                height="32"
                                                decoding="async"
                                                loading="lazy"
                                                alt=""
                                            />
                                            <div
                                                class:list={[styles.caption, 'caption']}
                                                aria-disabled="true"
                                            >
                                                :{emoji.code}:
                                            </div>
                                        </button>
                                    );
                                })}
                        </div>
                    </div>
                ))}
        </emoji-picker>
    )
}

<script>
    import EmojiPicker from './EmojiPicker.ts';

    if (!customElements.get('emoji-picker')) {
        customElements.define('emoji-picker', EmojiPicker);
    }
</script>

<script>
    // function setupEmojiButtons() {
    //     const buttons = document.querySelectorAll('.emoji-btn');

    //     buttons.forEach(button => {
    //         button.addEventListener('click', () => {
    //             const code = button.getAttribute('data-code');
    //             const caption = button.querySelector('.emoji-caption');

    //             if (code && caption) {
    //                 try {
    //                     console.log('copying');
    //                     navigator.clipboard.writeText(`:${code}:`).then(() => {
    //                         caption.textContent = 'copiado ✓';
    //                         caption.classList.add('copied');

    //                         setTimeout(() => {
    //                             caption.textContent = `:${code}:`;
    //                             caption.classList.remove('copied');
    //                         }, 700);
    //                     });
    //                 } catch (_e) {
    //                     console.log('copying failed');
    //                 } finally {
    //                     console.log('finally');
    //                 }
    //             }
    //         });
    //     });
    // }

    // // Run on initial load
    // setupEmojiButtons();

    // // Run on view transitions navigation
    // document.addEventListener('astro:page-load', setupEmojiButtons);
</script>
